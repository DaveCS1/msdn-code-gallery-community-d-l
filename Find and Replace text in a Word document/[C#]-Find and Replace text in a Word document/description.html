<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="https://i-msdn.sec.s-msft.com/Combined.css?resources=0:Header,0:HeaderFooterSprite,0:Header.NonMtps;/Areas/Centers/Themes/StandardDevCenter/Content:0&amp;amp;v=1B9152C29A0457AFEC33526CDFADF105" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="https://i-msdn.sec.s-msft.com/Combined.css?resources=0:Footer,0:HeaderFooterSprite,0:Footer.NonMtps,1:NewFooterSock,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;v=D636919224FCD4EE55642CE3BF1E3856" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Find and Replace text in a Word document</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="https://i1.code.msdn.s-msft.com/content/common/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="https://i1.code.msdn.s-msft.com/content/common/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Find and Replace text in a Word document</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            C#, .NET Framework, Office Open XML
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            C#, Find and Replace in Word
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Desktop
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">9/2/2016</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">MIT</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="https://code.msdn.microsoft.com/Find-and-Replace-text-in-a-296bf75c">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<p>From the following link, you can download the latest version of the C# source code for the FindAndReplace .NET application:<br>
<a class="download" title="Demo Application FindAndReplace.zip" href="http://www.gemboxsoftware.com/Document/ArticlesResources/FindAndReplace.zip">Download FindAndReplace.zip</a></p>
<h2>Introduction</h2>
<p>Searching a Word document's text and replacing it with text from a .NET application is a rather common task. This article will mention various approaches that we can use and also show how we can
<strong>search and replace the Word document's text using only the .NET Framework</strong> (without using any third-party code). To follow the implementation details, a
<strong>basic knowledge of WordprocessingML is required</strong>.</p>
<p style="text-align:center"><img id="159174" src="description/Find-And-Replace-Word-Document.png" alt="" width="600" height="264"></p>
<h2>Details</h2>
<p>If we have the option to use Word Automation (which requires having MS Word installed), then we can achieve the find and replace functionality with an API provided by Word Interop, as demonstrated
<a title="How to: Programmatically Search for and Replace Text in Documents" href="https://code.msdn.microsoft.com/Find-and-Replace-text-in-a-296bf75c/https://msdn.microsoft.com/en-us/library/f1f367bx.aspx" >
here</a>. Another way would be to read the whole main part of the DOCX file (<em>document.xml</em>) as
<code>string</code> and perform a find and replace on it, as demonstrated <a title="How to: Search and replace text in a document part (Open XML SDK)" href="https://code.msdn.microsoft.com/Find-and-Replace-text-in-a-296bf75c/https://msdn.microsoft.com/en-us/library/office/bb508261.aspx" >
here</a>.&nbsp;This simple approach may be enough, but a problem occurs when the searched text is not the value of a single XML element, for example, consider the following DOCX file:</p>
<p style="text-align:center"><img id="159175" src="description/Hello-Word-Document.png" alt="" width="391" height="139"></p>
<p style="text-align:center">Picture 1: Hello World sample document</p>
<p>The document's main part will look something like the following:</p>
<pre style="color:black; font-family:Consolas; font-size:13px; line-height:16px; margin-bottom:15px"><span style="color:blue">&lt;</span><span style="color:#a31515">p</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&lt;</span><span style="color:#a31515">r</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515">rPr</span><span style="color:blue">&gt;&lt;</span><span style="color:#a31515">color</span><span style="color:blue">&nbsp;</span><span style="color:red">val</span><span style="color:blue">=</span>&quot;<span style="color:blue">FF0000</span>&quot;<span style="color:blue">/&gt;&lt;/</span><span style="color:#a31515">rPr</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span>Hello&nbsp;<span style="color:blue">&lt;/</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&lt;/</span><span style="color:#a31515">r</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&lt;</span><span style="color:#a31515">r</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515">rPr</span><span style="color:blue">&gt;&lt;</span><span style="color:#a31515">color</span><span style="color:blue">&nbsp;</span><span style="color:red">val</span><span style="color:blue">=</span>&quot;<span style="color:blue">0000FF</span>&quot;<span style="color:blue">/&gt;&lt;/</span><span style="color:#a31515">rPr</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span>World<span style="color:blue">&lt;/</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&lt;/</span><span style="color:#a31515">r</span><span style="color:blue">&gt;</span><br><span style="color:blue">&lt;/</span><span style="color:#a31515">p</span><span style="color:blue">&gt;</span></pre>
<p>Another situation, for example, is the following:</p>
<pre style="color:black; font-family:Consolas; font-size:13px; line-height:16px; margin-bottom:15px"><span style="color:blue">&lt;</span><span style="color:#a31515">p</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&lt;</span><span style="color:#a31515">r</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span>Hello<span style="color:blue">&lt;/</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515">t</span><span style="color:blue">&gt;&nbsp;&lt;/</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span>World<span style="color:blue">&lt;/</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&lt;/</span><span style="color:#a31515">r</span><span style="color:blue">&gt;</span><br><span style="color:blue">&lt;/</span><span style="color:#a31515">p</span><span style="color:blue">&gt;</span></pre>
<p>So the text that we're looking for inside our Word document may span over multiple elements and we need to consider this when searching for it.</p>
<h2>Implementation</h2>
<p>We'll open the Word document and present it with a <code>FlatDocument</code> object. This object will read document parts (like the body, headers, footers, comments, etc.) and store them as a collection of
<code>XDocument</code> objects. The <code>FlatDocument</code> object will also create a set of
<code>FlatTextRange</code> objects that represent searchable parts of the document's text content (a single
<code>FlatTextRange</code> can represent a single paragraph, a single hyperlink etc.). Each
<code>FlatTextRange</code> will contain <code>FlatText</code> objects that have an indexed text content (<code>FlatText.StartIndex</code> and
<code>FlatText.EndIndex</code> represent the <code>FlatText</code>'s text location inside the
<code>FlatTextRange</code>'s text).</p>
<h3>Steps</h3>
<ol>
<li>Open Word document:
<p>&nbsp;</p>
<pre style="color:black; font-family:Consolas; font-size:13px; line-height:16px; margin-bottom:15px"><span style="color:blue">public</span>&nbsp;<span style="color:blue">sealed</span>&nbsp;<span style="color:blue">class</span>&nbsp;<span style="color:#2b91af">FlatDocument</span>&nbsp;:&nbsp;<span style="color:#2b91af">IDisposable</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">public</span>&nbsp;FlatDocument(<span style="color:blue">string</span>&nbsp;path)&nbsp;:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">this</span>(<span style="color:#2b91af">File</span>.Open(path,&nbsp;<span style="color:#2b91af">FileMode</span>.Open,&nbsp;<span style="color:#2b91af">FileAccess</span>.ReadWrite))&nbsp;{&nbsp;}<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">public</span>&nbsp;FlatDocument(<span style="color:#2b91af">Stream</span>&nbsp;stream)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">this</span>.documents&nbsp;=&nbsp;<span style="color:#2b91af">XDocumentCollection</span>.Open(stream);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">this</span>.ranges&nbsp;=&nbsp;<span style="color:blue">new</span>&nbsp;List&lt;<span style="color:#2b91af">FlatTextRange</span>&gt;();<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">this</span>.CreateFlatTextRanges();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;...</span><br>}</pre>
</li><li>Iterate through the Run elements of the supported document parts (body, headers, footers, comments, endnotes and footnotes, which are loaded as
<code>XDocument</code> objects) and create <code>FlatTextRange</code> and <code>FlatText</code> instances:
<p>&nbsp;</p>
<pre style="color:black; font-family:Consolas; font-size:13px; line-height:16px; margin-bottom:15px"><span style="color:blue">public</span>&nbsp;<span style="color:blue">sealed</span>&nbsp;<span style="color:blue">class</span>&nbsp;<span style="color:#2b91af">FlatDocument</span>&nbsp;:&nbsp;<span style="color:#2b91af">IDisposable</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">private</span>&nbsp;<span style="color:blue">void</span>&nbsp;CreateFlatTextRanges()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">foreach</span>&nbsp;(<span style="color:#2b91af">XDocument</span>&nbsp;document&nbsp;<span style="color:blue">in</span>&nbsp;<span style="color:blue">this</span>.documents)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af">FlatTextRange</span>&nbsp;currentRange&nbsp;=&nbsp;<span style="color:blue">null</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">foreach</span>&nbsp;(<span style="color:#2b91af">XElement</span>&nbsp;run&nbsp;<span style="color:blue">in</span>&nbsp;document.Descendants(<span style="color:#2b91af">FlatConstants</span>.RunElementName))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">if</span>&nbsp;(!run.HasElements)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">continue</span>;<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af">FlatText</span>&nbsp;flatText&nbsp;=&nbsp;FlattenRunElement(run);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">if</span>&nbsp;(flatText&nbsp;==&nbsp;<span style="color:blue">null</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">continue</span>;<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;If&nbsp;the&nbsp;current&nbsp;Run&nbsp;doesn't&nbsp;belong&nbsp;to&nbsp;the&nbsp;same&nbsp;parent</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;(like&nbsp;a&nbsp;paragraph,&nbsp;hyperlink,&nbsp;etc.),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;create&nbsp;a&nbsp;new&nbsp;FlatTextRange,&nbsp;otherwise&nbsp;use&nbsp;the&nbsp;current&nbsp;one.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">if</span>&nbsp;(currentRange&nbsp;==&nbsp;<span style="color:blue">null</span>&nbsp;||&nbsp;currentRange.Parent&nbsp;!=&nbsp;run.Parent)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentRange&nbsp;=&nbsp;<span style="color:blue">this</span>.CreateFlatTextRange(run.Parent);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentRange.AddFlatText(flatText);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;...</span><br>}</pre>
</li><li>Flatten Run elements, which <em>splits a single Run element into multiple sequential Run elements that have a single content child element</em> (and optionally the first RunProperties child element). Create a
<code>FlatText</code> object from the flat Run element:
<p>&nbsp;</p>
<p style="text-align:center"><img id="159176" src="description/Flatten-Run-element.png" alt="" width="426" height="152"></p>
<p style="text-align:center">Picture 2: Flatten Run element</p>
<p style="text-align:center"><img id="159177" src="description/Flat-Objects.png" alt="" width="275" height="123"></p>
<p style="text-align:center">Picture 3: Flat objects</p>
<p style="text-align:center"><img id="159178" src="description/Flat-Objects-Text-Content.png" alt="" width="220" height="150"></p>
<p style="text-align:center">Picture 4: Flat objects text content</p>
<pre style="color:black; font-family:Consolas; font-size:13px; line-height:16px; margin-bottom:15px"><span style="color:blue">public</span>&nbsp;<span style="color:blue">sealed</span>&nbsp;<span style="color:blue">class</span>&nbsp;<span style="color:#2b91af">FlatDocument</span>&nbsp;:&nbsp;<span style="color:#2b91af">IDisposable</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">private</span>&nbsp;<span style="color:blue">static</span>&nbsp;<span style="color:#2b91af">FlatText</span>&nbsp;FlattenRunElement(<span style="color:#2b91af">XElement</span>&nbsp;run)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af">XElement</span>[]&nbsp;childs&nbsp;=&nbsp;run.Elements().ToArray();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af">XElement</span>&nbsp;runProperties&nbsp;=&nbsp;childs[0].Name&nbsp;==&nbsp;<span style="color:#2b91af">FlatConstants</span>.RunPropertiesElementName&nbsp;?<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;childs[0]&nbsp;:&nbsp;<span style="color:blue">null</span>;<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">int</span>&nbsp;childCount&nbsp;=&nbsp;childs.Length;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">int</span>&nbsp;flatChildCount&nbsp;=&nbsp;1&nbsp;&#43;&nbsp;(runProperties&nbsp;!=&nbsp;<span style="color:blue">null</span>&nbsp;?&nbsp;1&nbsp;:&nbsp;0);<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;Break&nbsp;the&nbsp;current&nbsp;Run&nbsp;into&nbsp;multiple&nbsp;Run&nbsp;elements&nbsp;that&nbsp;have&nbsp;one&nbsp;child,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;or&nbsp;two&nbsp;children&nbsp;if&nbsp;it&nbsp;has&nbsp;RunProperties&nbsp;element&nbsp;as&nbsp;a&nbsp;first&nbsp;child.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">while</span>&nbsp;(childCount&nbsp;&gt;&nbsp;flatChildCount)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;Move&nbsp;the&nbsp;last&nbsp;child&nbsp;element&nbsp;from&nbsp;the&nbsp;current&nbsp;Run&nbsp;into&nbsp;the&nbsp;new&nbsp;Run,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;which&nbsp;is&nbsp;added&nbsp;after&nbsp;the&nbsp;current&nbsp;Run.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af">XElement</span>&nbsp;child&nbsp;=&nbsp;childs[childCount&nbsp;-&nbsp;1];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run.AddAfterSelf(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">new</span>&nbsp;<span style="color:#2b91af">XElement</span>(<span style="color:#2b91af">FlatConstants</span>.RunElementName,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;runProperties&nbsp;!=&nbsp;<span style="color:blue">null</span>&nbsp;?&nbsp;<span style="color:blue">new</span>&nbsp;<span style="color:#2b91af">XElement</span>(runProperties)&nbsp;:&nbsp;<span style="color:blue">null</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">new</span>&nbsp;<span style="color:#2b91af">XElement</span>(child)));<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child.Remove();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--childCount;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af">XElement</span>&nbsp;remainingChild&nbsp;=&nbsp;childs[childCount&nbsp;-&nbsp;1];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">return</span>&nbsp;remainingChild.Name&nbsp;==&nbsp;<span style="color:#2b91af">FlatConstants</span>.TextElementName&nbsp;?<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">new</span>&nbsp;<span style="color:#2b91af">FlatText</span>(remainingChild)&nbsp;:&nbsp;<span style="color:blue">null</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;...</span><br>}</pre>
</li><li>Perform find and replace over <code>FlatTextRange</code> instances:
<p>&nbsp;</p>
<pre style="color:black; font-family:Consolas; font-size:13px; line-height:16px; margin-bottom:15px"><span style="color:blue">public</span>&nbsp;<span style="color:blue">sealed</span>&nbsp;<span style="color:blue">class</span>&nbsp;<span style="color:#2b91af">FlatDocument</span>&nbsp;:&nbsp;<span style="color:#2b91af">IDisposable</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">public</span>&nbsp;<span style="color:blue">void</span>&nbsp;FindAndReplace(<span style="color:blue">string</span>&nbsp;find,&nbsp;<span style="color:blue">string</span>&nbsp;replace)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">this</span>.FindAndReplace(find,&nbsp;replace,&nbsp;<span style="color:#2b91af">StringComparison</span>.CurrentCulture);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">public</span>&nbsp;<span style="color:blue">void</span>&nbsp;FindAndReplace(<span style="color:blue">string</span>&nbsp;find,&nbsp;<span style="color:blue">string</span>&nbsp;replace,&nbsp;<span style="color:#2b91af">StringComparison</span>&nbsp;comparisonType)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">this</span>.ranges.ForEach(range&nbsp;=&gt;&nbsp;range.FindAndReplace(find,&nbsp;replace,&nbsp;comparisonType));<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;...</span><br>}<br> <br><span style="color:blue">internal</span>&nbsp;<span style="color:blue">sealed</span>&nbsp;<span style="color:blue">class</span>&nbsp;<span style="color:#2b91af">FlatTextRange</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">public</span>&nbsp;<span style="color:blue">void</span>&nbsp;FindAndReplace(<span style="color:blue">string</span>&nbsp;find,&nbsp;<span style="color:blue">string</span>&nbsp;replace,&nbsp;<span style="color:#2b91af">StringComparison</span>&nbsp;comparisonType)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">int</span>&nbsp;searchStartIndex&nbsp;=&nbsp;-1,&nbsp;searchEndIndex&nbsp;=&nbsp;-1,&nbsp;searchPosition&nbsp;=&nbsp;0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">while</span>&nbsp;((searchStartIndex&nbsp;=<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">this</span>.rangeText.ToString().IndexOf(find,&nbsp;searchPosition,&nbsp;comparisonType))&nbsp;!=&nbsp;-1)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;searchEndIndex&nbsp;=&nbsp;searchStartIndex&nbsp;&#43;&nbsp;find.Length&nbsp;-&nbsp;1;<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;Find&nbsp;FlatText&nbsp;that&nbsp;contains&nbsp;the&nbsp;beginning&nbsp;of&nbsp;the&nbsp;searched&nbsp;text.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LinkedListNode&lt;FlatText&gt;&nbsp;node&nbsp;=&nbsp;<span style="color:blue">this</span>.FindNode(searchStartIndex);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FlatText&nbsp;flatText&nbsp;=&nbsp;node.Value;<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReplaceText(flatText,&nbsp;searchStartIndex,&nbsp;searchEndIndex,&nbsp;replace);<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;Remove&nbsp;next&nbsp;FlatTexts&nbsp;that&nbsp;contain&nbsp;parts&nbsp;of&nbsp;the&nbsp;searched&nbsp;text.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">this</span>.RemoveNodes(node,&nbsp;searchEndIndex);<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">this</span>.ResetRangeText();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;searchPosition&nbsp;=&nbsp;searchStartIndex&nbsp;&#43;&nbsp;replace.Length;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;...</span><br>}</pre>
</li><li>Finally, <code>FlatDocument.Dispose</code> will save the <code>XDocument</code> parts and close the Word document.
</li></ol>
<h3>Usage</h3>
<p>The following sample code demonstrates how to use <code>FlatDocument</code>:</p>
<pre style="color:black; font-family:Consolas; font-size:13px; line-height:16px; margin-bottom:15px"><span style="color:blue">class</span>&nbsp;<span style="color:#2b91af">Program</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">static</span>&nbsp;<span style="color:blue">void</span>&nbsp;Main(<span style="color:blue">string</span>[]&nbsp;args)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;Open&nbsp;the&nbsp;Word&nbsp;file.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">using</span>&nbsp;(<span style="color:blue">var</span>&nbsp;flatDocument&nbsp;=&nbsp;<span style="color:blue">new</span>&nbsp;<span style="color:#2b91af">FlatDocument</span>(<span style="color:#a31515">&quot;Sample.docx&quot;</span>))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;Search&nbsp;and&nbsp;replace&nbsp;the&nbsp;document's&nbsp;text&nbsp;content.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flatDocument.FindAndReplace(<span style="color:#a31515">&quot;Hello&nbsp;Word&quot;</span>,&nbsp;<span style="color:#a31515">&quot;New&nbsp;Value&nbsp;1&quot;</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flatDocument.FindAndReplace(<span style="color:#a31515">&quot;Foo&nbsp;Bar&quot;</span>,&nbsp;<span style="color:#a31515">&quot;New&nbsp;Value&nbsp;2&quot;</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;...</span><br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;Save&nbsp;the&nbsp;Word&nbsp;file&nbsp;on&nbsp;Dispose.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}</pre>
<h2>Points of Interest</h2>
<p>An alternative algorithm to that above is to <em>split a single Run element into multiple sequential Run elements that have a single child (the same as above), but in this case a single child element would contain only a single character</em>:</p>
<pre style="color:black; font-family:Consolas; font-size:13px; line-height:16px; margin-bottom:15px"><span style="color:blue">&lt;</span><span style="color:#a31515">p</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&lt;</span><span style="color:#a31515">r</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span>H<span style="color:blue">&lt;/</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&lt;/</span><span style="color:#a31515">r</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&lt;</span><span style="color:#a31515">r</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span>e<span style="color:blue">&lt;/</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&lt;/</span><span style="color:#a31515">r</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&lt;</span><span style="color:#a31515">r</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span>l<span style="color:blue">&lt;/</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&lt;/</span><span style="color:#a31515">r</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&lt;</span><span style="color:#a31515">r</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span>l<span style="color:blue">&lt;/</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&lt;/</span><span style="color:#a31515">r</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&lt;</span><span style="color:#a31515">r</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span>o<span style="color:blue">&lt;/</span><span style="color:#a31515">t</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&lt;/</span><span style="color:#a31515">r</span><span style="color:blue">&gt;</span><br><span style="color:blue">&nbsp;&nbsp;&lt;!--</span><br><span style="color:green">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br><span style="color:green">&nbsp;&nbsp;</span><span style="color:blue">--&gt;</span><br><span style="color:blue">&lt;/</span><span style="color:#a31515">p</span><span style="color:blue">&gt;</span></pre>
<p>We would then iterate through those elements while looking for a sequence of matched characters. You can find the details and an implementation of this approach in the following article:
<a title="Search and Replace Text in an Open XML WordprocessingML Document" href="http://ericwhite.com/blog/search-and-replace-text-in-an-open-xml-wordprocessingml-document/" >
Search and Replace Text in an Open XML WordprocessingML Document</a> This approach is actually used in the
<a href="https://code.msdn.microsoft.com/Find-and-Replace-text-in-a-296bf75c/https://github.com/OfficeDev/Open-Xml-PowerTools" >Open XML PowerTools</a> (<code>TextReplacer</code> class). However, the problem with both of these algorithms is that they do not work on content that spans over multiple paragraphs.
 In this case, we would need to <em>flatten the entire content of the Word document to search for the required text successfully</em>.
<a title="C# / VB.NET Word component" href="http://www.gemboxsoftware.com/document/overview" >
GemBox.Document</a> is a .NET component for processing Word files that presents a document with a
<a href="http://www.gemboxsoftware.com/Document/help/html/Content_Model.htm" >
content model hierarchy</a> that can be accessed as flat content through the <code>
ContentRange</code> class. With it, we are able to search for content that spans over multiple paragraphs. For details, see the following article:
<a href="http://www.gemboxsoftware.com/Document/Examples/Find-Replace-Word-Csharp-Vbnet/405" >
Find and Replace in Word with C# or VB.NET</a> With this approach, we are actually able to find any arbitrary content and replace it with any desired content (including tables, pictures, paragraphs, HTML formatted text, RTF formatted text, etc.).</p>
<h2>Improvements</h2>
<ul>
<li>Currently the replace text will have the same formatting as used at the beginning of the found text. However, we could consider providing a
<code>FindAndReplace</code> overload method that would accept the desired formatting (for example, something like:
<code>FlatDocument.FindAndReplace(string find, string replace, TextFormat format)</code>). When the formatting is provided, we would need to create a new RunProperties element based on it.
</li><li>Currently any special characters (like tabs, line breaks, non-breaking hyphens, etc.) in both the search and replace texts are not considered. For this,
<code>FlatText</code> should be aware of the different element types that <code>FlatText.textElement</code> can be (like
<em>&lt;tab/&gt;</em>, <em>&lt;br/&gt;</em>, <em>&lt;noBreakHyphen/&gt;</em>, etc.) and return the appropriate
<code>FlatText.Text</code> value based on it. </li></ul>

</div>


    </div>
</body>
</html>
